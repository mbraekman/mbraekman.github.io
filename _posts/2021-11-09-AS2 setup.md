---
layout: post
author: Maxim Braekman
title: Setting up an AS2 connection
description: What exactly is AS2 and how can it be configured on either BizTalk Server or Azure Integration Services.
image: ./img/setup-as2.jpg
tags: [BizTalk Server, Azure Integration Services]
---

Many of the B2B-connections are still making use of an AS2-connection to exchange documents. Below you will be able to find out how this can be configured in BizTalk Server and in Azure Integration Services.  
But before we can dive into the how, let's start with the what; what is the AS2-protocol and how does it work.

## Steps
- [What is AS2](#what-is-as2)
- [Getting Started](#getting-started)
- [How to configure BizTalk Server](#how-to-configure-biztalk-server)
- [How to configure Azure Integration Services](#how-to-configure-azure-integration-services)
- [Conclusion](#conclusion)
  
### What is AS2
AS2, or _Applicability Statement 2_, is a HTTP-based protocol used to transmit messages in a fast and secure manner, primarily used for the business-to-business exchange of documents.  

But how does it work?  
Each message that is to be transmitted towards a specific receiver, _can_ be encrypted and/or _can_ be signed. _Can_, because even though most of the times both are being enabled, this is not a strict requirement for making use of this protocol.  
Next to this, each message should be replied by a sync or async MDN (_or Message Disposition Notification_), which is a technical acknowledgement that indicates the message has been successfully received, has been decrypted and of which the signature has been verified.  
In the diagram below, you can see graphical representation of the exchange of these messages.  

![Protocol Overview](../../../../img/posts/as2-setup/protocol-overview.png)  

### Getting Started
Before you can start configuring the AS2-connection, there are a couple of prerequisites you will need:  
- [Home Organization Certificate](#home-organization-certificate)  
- [Home Organization connection details](#home-organization-connection-details)   
- [Partner Certificate](#partner-certificate)  
- [Partner connection details](#partner-connection-details)  

#### Home Organization Certificate
As you can see in the above overview, it is the private certificate of the home organization that is used to sign the outgoing messages or the decrypt the incoming messages.  
Therefore it is important that before starting with any configuration you obtain this certificate.  
__*IMPORTANT*: Store this private certificate in a secure location and make sure you never share the password of this certificate with anyone outside of your organization. If you do share this password, that means other people can impersonate themselves as being part of your organization and exchange falsified documents on your behalf.__  

A certificate can be obtained by buying it from one of the certified authorities (eg. DigiCert, GoDaddy, ...)  OR you could generate a self-signed certificate by using the below command which generates and stores it within your user-specific certificate store:
```powershell
makecert -r -pe -n "CN=Home organization AS2 SHA256" -b 03/31/2022 -e 04/01/2024 -eku 1.3.6.1.5.5.7.3.1 -ss my "HomeOrganization.AS2.SHA256.cer" -sr currentuser -sky exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 -a "sha256" -nscp -len 2048
```  

_NOTE: Whether you are buying or generating a certificate, from a security perspective, it is advised to use environment-specific certificates._  

#### Home Organization connection details
Setting up an AS2-connection requires quite some toggles to be switched, which should be matched by the configuration that is to be set up in the system of your partner.  
So it's best to make sure you always have at least the following details at hand:  
- AS2 endpoint:  
  What is the publicly accessible endpoint which can be used by partners to deliver documents
- Public IP:  
  What is your public IP-address which will be used to sent documents towards your partner, as they might have a firewall in place limiting access to their endpoint.
- AS2 Identifier:  
  How will your system identify itself against the outside world. This value will be used to identify which configuration settings should be used during the decryption or validation process.  
  Try and stick to the same value as your and your partners' configuration will depend on it.  
- Hashing algorithm:  
- Encryption algorithm:  
- MDN Settings:
  - Is a MDN required?  
    This is definitely advised, as it is a technical acknowledgement by the receivers system, specifying the document has been received successfully.  
    *Note:* This is a confirmation that the document has been received, NOT that it has been processed, which is important to understand.
  - Does the MDN have to be signed and if so, what algorithm is used?  
    Basically indicates whether to send the MDN as plain text or signed, using the same certificate as the main payload.  
  - Sync vs Async?  
    Should the MDN be returned as a direct response to the tranmission of the main payload, or should it be sent as a seperate message, to an AS2-endpoint?

#### Partner Certificate
To configure the connection to use the appropriate certificate for encrypting the outbound document or verify the signing of the incoming document, you need to obtain a copy of the public certificate from your partner.  
As opposed to the home organization certificate this is not something you can help out with. This certificate should be bought/generated by the partner organizations themselves.

#### Partner connection details
Again some more connection details should be known before you can configure the AS2 connection, but this time the details should come from your partners' system:
- AS2 endpoint:  
  The publicly accessibl endpoint where documents should be sent towards.  
- Public IP:  
  If you have a firewall in place, you should request the public IP-address of their system, in order for you to configure a new firewall rule to accept the traffic.
- AS2 Identifier:  
  As mentioned earlier, this is the unique identifier which will be used during the validation process to identify the settings to use.
- Hashing algorithm: See above  
- Encryption algorithm: See above  
- MDN Settings: See above


### How to configure BizTalk Server



### Conclusion